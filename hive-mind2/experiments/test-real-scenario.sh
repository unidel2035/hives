#!/bin/bash

# Test script to reproduce the exact scenario from the logs

echo "=== Reproducing the 'No commits between branches' scenario ==="
echo ""

echo "Scenario: Second run with --auto-continue reuses existing branch"
echo ""

echo "Step 1: First run creates branch and commits CLAUDE.md"
echo "  - Branch: issue-1-b53fe3666f91"
echo "  - Commit: 8ee8459 with CLAUDE.md"
echo "  - Push succeeds"
echo "  - PR creation fails (network/permission/etc)"
echo ""

echo "Step 2: Second run with --auto-continue"
echo "  - Checkout existing branch: issue-1-b53fe3666f91"
echo "  - CLAUDE.md exists (from first run)"
echo "  - Read content: 'Task: Issue #1'"
echo "  - Append: '\\n\\n---\\n\\nTask: Issue #1' (SAME content!)"
echo "  - Write CLAUDE.md"
echo "  - Git sees file modified (write operation happened)"
echo "  - Create commit: 9d8c4fc"
echo "  - Push: 8ee8459..9d8c4fc"
echo "  - Try PR creation..."
echo ""

echo "Step 3: Why PR creation fails"
echo "  - Git commit exists: 9d8c4fc"
echo "  - Git tree of 9d8c4fc == Git tree of 8ee8459"
echo "  - Why? Because CLAUDE.md content is identical!"
echo "  - GitHub compares trees, not commits"
echo "  - Result: 'No commits between master and issue-1-b53fe3666f91'"
echo ""

echo "The key insight:"
echo "  Git creates a commit when you run 'git commit'"
echo "  EVEN IF the tree (content) hasn't changed from parent!"
echo "  This creates a commit with a different SHA but identical tree"
echo ""

echo "Test this locally:"
echo "  $ mkdir test-repo && cd test-repo"
echo "  $ git init"
echo "  $ echo 'hello' > file.txt"
echo "  $ git add file.txt && git commit -m 'Add file'"
echo "  $ echo 'hello' > file.txt  # Same content!"
echo "  $ git add file.txt && git commit -m 'Update file'  # Different commit SHA"
echo "  $ git log --oneline  # Shows 2 commits"
echo "  $ git diff HEAD^ HEAD  # Shows NO diff"
echo ""

echo "This is exactly what happens with CLAUDE.md when --auto-continue reuses branch!"
echo ""

echo "=== Why the timestamp fix works ==="
echo ""
echo "With timestamp:"
echo "  First run: CLAUDE.md = 'Task: Issue #1'"
echo "  Second run: CLAUDE.md = 'Task: Issue #1\\n\\n---\\n\\nTask: Issue #1\\n\\nRun timestamp: 2025-11-05T10:00:15.118Z'"
echo "  Content IS different → Tree changes → PR creation works"
echo ""

echo "=== Why fork mode breaks (v0.29.7) ==="
echo ""
echo "Compare API call:"
echo "  gh api repos/xlabtg/anti-corruption/compare/main...issue-6-01d3f376c347"
echo ""
echo "Problem: Branch 'issue-6-01d3f376c347' doesn't exist in 'xlabtg/anti-corruption'"
echo "It exists in 'konard/anti-corruption' (the fork)"
echo ""
echo "Fix (v0.29.9):"
echo "  gh api repos/xlabtg/anti-corruption/compare/main...konard:issue-6-01d3f376c347"
echo ""
echo "This tells GitHub to look in konard's fork for the branch"
echo ""

echo "=== Summary ==="
echo ""
echo "Both fixes are correct:"
echo "  1. Timestamp ensures content changes when reusing branches"
echo "  2. Fork mode fix ensures Compare API looks in the right place"
echo ""
echo "The logs show OLD versions failing:"
echo "  - v0.29.5 logs: No timestamp → identical content → PR fails"
echo "  - v0.29.7 logs: Compare API 404 → fork mode broken"
echo ""
echo "Current version (v0.29.9) has both fixes and should work!"
echo ""
