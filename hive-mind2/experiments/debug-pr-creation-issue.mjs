#!/usr/bin/env node

/**
 * Debug script to understand the PR creation failure
 *
 * This is a theoretical analysis based on the logs.
 */

console.log('=== PR Creation Debug Experiment ===\n');

// The issue: When auto-continue finds an existing branch without a PR,
// it checks out that branch, adds/updates CLAUDE.md, commits, pushes,
// and then tries to create a PR. But GitHub says "No commits between branches".

console.log('Theory 1: The issue is that when CLAUDE.md is appended with the same content,');
console.log('         git sees no actual changes, so nothing gets staged/committed.');
console.log('');
console.log('Theory 2: The branch might already have all commits from master, and the');
console.log('         CLAUDE.md commit is the only difference. When we force-push a new');
console.log('         CLAUDE.md commit, GitHub might see it as "replacing" the previous one');
console.log('         rather than "adding" a new commit on top of master.');
console.log('');
console.log('Theory 3: The problem is that when checking out an existing branch,');
console.log('         the branch already diverged from master, and we are adding a commit');
console.log('         on top of that diverged state. But if the original divergence was');
console.log('         JUST the CLAUDE.md file, and we force-push to replace it, GitHub');
console.log('         might not see any net difference from master.');
console.log('');
console.log('Theory 4 (MOST LIKELY): When we checkout an existing branch and it already');
console.log('         has CLAUDE.md, appending to it creates the SAME content if the');
console.log('         task info is identical. Git status shows "M CLAUDE.md" but the');
console.log('         actual diff might be ZERO or the commit might have the same tree SHA.');
console.log('         This would mean "nothing to commit" even though git add succeeded.');
console.log('');

console.log('Looking at the logs:');
console.log('- First run: Branch created, CLAUDE.md added, commit 8ee8459, PR creation failed');
console.log('- Second run: Branch checked out, CLAUDE.md "appended", commit 9d8c4fc, PR creation failed again');
console.log('');
console.log('Key observation from second run log line 78:');
console.log('  "Git status after add: M  CLAUDE.md"');
console.log('This shows CLAUDE.md was staged as MODIFIED (not Added).');
console.log('');
console.log('Key observation from second run log line 94:');
console.log('  "8ee8459..9d8c4fc  issue-1-b53fe3666f91 -> issue-1-b53fe3666f91"');
console.log('This shows the push WAS successful and created a NEW commit.');
console.log('');
console.log('So the commit exists, but GitHub still says "No commits between master and issue-1-b53fe3666f91".');
console.log('');
console.log('This means: The branch issue-1-b53fe3666f91 (after the push) has NO commits');
console.log('that are not in master. Even though we just pushed a new commit.');
console.log('');
console.log('HYPOTHESIS: The branch was created FROM master, but after the first run failed,');
console.log('the branch on GitHub still only has commits that are IN master (because CLAUDE.md');
console.log('commit is not in master, but it is the ONLY commit in the branch, so the branch');
console.log('BASE is still master, making it appear as if there are no commits BETWEEN them).');
console.log('');
console.log('WAIT - that doesn\'t make sense. If branch has 1 commit (CLAUDE.md) that master');
console.log('doesn\'t have, then there SHOULD be 1 commit between them.');
console.log('');
console.log('Re-reading the error more carefully:');
console.log('  "GraphQL: Head sha can\'t be blank, Base sha can\'t be blank,');
console.log('   No commits between master and issue-1-b53fe3666f91,');
console.log('   Head ref must be a branch (createPullRequest)"');
console.log('');
console.log('The error says BOTH "Head sha can\'t be blank" AND "Base sha can\'t be blank"');
console.log('This suggests GitHub API is not receiving the SHA values at all!');
console.log('');
console.log('NEW HYPOTHESIS: The gh pr create command is not properly specifying');
console.log('the head SHA or base SHA, so GitHub API receives blank/null values.');
console.log('This would cause it to fail to find ANY commits between the branches.');
console.log('');
console.log('Looking at the command used (line 135 in second log):');
console.log('  cd "/tmp/gh-issue-solver-1762336804082" && gh pr create --draft');
console.log('    --title "$(cat \'/tmp/pr-title-1762336826963.txt\')"');
console.log('    --body-file "/tmp/pr-body-1762336826961.md"');
console.log('    --base master');
console.log('    --head issue-1-b53fe3666f91');
console.log('');
console.log('The command looks correct. It specifies:');
console.log('  --base master');
console.log('  --head issue-1-b53fe3666f91');
console.log('');
console.log('So why would GitHub say the SHAs are blank?');
console.log('');
console.log('CRITICAL INSIGHT: When gh pr create is run, it needs to resolve the branch');
console.log('names to SHAs. If GitHub doesn\'t have the branches synced yet, or if there');
console.log('is a race condition, it might fail to resolve them and return blank SHAs.');
console.log('');
console.log('Looking at the code, I see there\'s a wait period (line 469 in the source):');
console.log('  await new Promise(resolve => setTimeout(resolve, 8000)); // Wait for GitHub');
console.log('');
console.log('And there\'s a verification step (lines 472-474):');
console.log('  branchCheckResult = await $ gh api repos/${owner}/${repo}/branches/${branchName}');
console.log('');
console.log('But in the logs, I see (line 101 in second run):');
console.log('  "Branch verified on GitHub: issue-1-b53fe3666f91"');
console.log('So the branch WAS found on GitHub!');
console.log('');
console.log('And line 102: "Remote commit SHA: 9d8c4fc..."');
console.log('So the commit SHA was also found!');
console.log('');
console.log('This means GitHub had the branch and commit before PR creation was attempted.');
console.log('');
console.log('So why did PR creation fail with "Head sha can\'t be blank"?');
console.log('');
console.log('ANOTHER HYPOTHESIS: The `gh pr create` command is being run with the wrong');
console.log('repository context. If it\'s trying to create a PR in the wrong repo, or if');
console.log('the branch name needs to be fully qualified (user:branch), that could cause');
console.log('GitHub to not find the branch and return blank SHAs.');
console.log('');
console.log('But looking at the code (lines 694-704), I don\'t see any explicit --repo flag');
console.log('for non-fork PRs. It relies on being in the correct directory with the correct');
console.log('git remote configured. This should work since we\'re in tempDir which was cloned');
console.log('from the correct repo.');
console.log('');
console.log('Final theory: Let me check if there\'s an issue with the BASE branch resolution.');
console.log('The command uses --base master, but what if GitHub doesn\'t recognize "master"');
console.log('as a valid branch name in this repo? The logs show "üìå Default branch: master"');
console.log('so that should be correct...');
console.log('');
console.log('BREAKTHROUGH: Looking at line 666 in the code:');
console.log('  await log(`   Base branch: ${defaultBranch}`, { verbose: true });');
console.log('This is logging defaultBranch, but the actual command uses --base ${targetBranch}');
console.log('which is defined as: const targetBranch = argv.baseBranch || defaultBranch;');
console.log('');
console.log('So there could be a mismatch! Let me check if targetBranch vs defaultBranch');
console.log('is causing the issue.');
console.log('');
console.log('Actually, looking at line 641 in code: the pr create uses --base ${targetBranch}');
console.log('And line 574: targetBranch is defined right before the fetch.');
console.log('And line 699: the final command uses --base ${targetBranch}');
console.log('');
console.log('So that\'s consistent. The issue must be elsewhere.');
console.log('');
console.log('WAIT! I just realized something. Looking at line 589 in the code:');
console.log('  git rev-list --count origin/${targetBranch}..HEAD');
console.log('');
console.log('This checks if there are commits between origin/master and HEAD (the current branch).');
console.log('But in the LOGS, I do NOT see this check being performed! The logs should show:');
console.log('  "üîç Checking: Commits between branches..."');
console.log('But that\'s MISSING from the logs!');
console.log('');
console.log('This means the code is FAILING before it reaches that check.');
console.log('The code is failing at line 739 when trying to execute the gh pr create command.');
console.log('');
console.log('So the root cause is: gh pr create itself is failing with the error:');
console.log('  "Head sha can\'t be blank, Base sha can\'t be blank,');
console.log('   No commits between master and issue-1-b53fe3666f91"');
console.log('');
console.log('This is a GitHub API error, not a local git error.');
console.log('');
console.log('=== ROOT CAUSE ANALYSIS ===');
console.log('');
console.log('The most likely root cause is a TIMING issue:');
console.log('1. We push the branch to GitHub');
console.log('2. We wait 8 seconds for GitHub to sync');
console.log('3. We verify the branch exists via API');
console.log('4. We immediately try to create a PR');
console.log('5. But GitHub\'s PR creation API might use a DIFFERENT backend/cache');
console.log('   that hasn\'t synced yet, causing it to not find the branch/commits.');
console.log('');
console.log('OR:');
console.log('');
console.log('There might be an issue with how `gh pr create` resolves branch names.');
console.log('When you specify --head branch-name, gh CLI might be looking for that');
console.log('branch in the CURRENT repository. But if the current directory is in');
console.log('a specific state (detached HEAD, wrong remote, etc.), it might not find it.');
console.log('');
console.log('Let me check the actual git state at the time of PR creation...');
console.log('From line 87-88 in the second run log:');
console.log('  "Branch info: * issue-1-b53fe3666f91 9d8c4fc [origin/issue-1-b53fe3666f91: ahead 1]"');
console.log('  "  master               63409aa [origin/master] Update zerocracy.yml"');
console.log('');
console.log('This shows:');
console.log('- Current branch: issue-1-b53fe3666f91 (9d8c4fc)');
console.log('- Branch is tracking origin/issue-1-b53fe3666f91');
console.log('- Branch is 1 commit ahead of its upstream');
console.log('- master is at 63409aa');
console.log('');
console.log('So the state looks correct!');
console.log('');
console.log('=== FINAL HYPOTHESIS ===');
console.log('');
console.log('I believe the issue is that the branch issue-1-b53fe3666f91 was created');
console.log('from master (63409aa), and only has 1 commit (the CLAUDE.md commit).');
console.log('When we run `gh pr create --base master --head issue-1-b53fe3666f91`,');
console.log('GitHub tries to compare master...issue-1-b53fe3666f91.');
console.log('');
console.log('But here\'s the catch: If the CLAUDE.md commit is an "empty" commit');
console.log('(same tree SHA as parent), or if GitHub for some reason doesn\'t see');
console.log('it as a valid commit, then the comparison would show no commits.');
console.log('');
console.log('Let me check if the commit is actually different from master...');
console.log('From line 88: "master 63409aa [origin/master]"');
console.log('From line 87: "issue-1-b53fe3666f91 9d8c4fc"');
console.log('');
console.log('So the commit SHAs are different. The branch clearly has a different commit.');
console.log('');
console.log('UPDATED THEORY: The issue might be with the REMOTE state vs LOCAL state.');
console.log('When gh pr create runs, it might be checking the REMOTE branches,');
console.log('not the local ones. And if origin/issue-1-b53fe3666f91 on GitHub');
console.log('hasn\'t been fully processed/indexed yet, GitHub API might not');
console.log('find the commits when doing the comparison.');
console.log('');
console.log('This would explain why:');
console.log('- git push succeeds (Git level works)');
console.log('- gh api repos/.../branches/... succeeds (Basic branch info works)');
console.log('- gh pr create fails (PR creation compares commits, which might');
console.log('  use a different index/cache that hasn\'t synced)');
console.log('');
console.log('SOLUTION: Increase the wait time, or add a retry mechanism,');
console.log('or verify that GitHub can actually see the commits (not just the branch)');
console.log('before attempting PR creation.');
console.log('');
console.log('ALTERNATIVE SOLUTION: Check if the commits comparison works before');
console.log('attempting PR creation. We can use:');
console.log('  gh api repos/{owner}/{repo}/compare/{base}...{head}');
console.log('This will tell us if GitHub sees the commits, and we can wait/retry');
console.log('until it does before calling gh pr create.');
console.log('');
